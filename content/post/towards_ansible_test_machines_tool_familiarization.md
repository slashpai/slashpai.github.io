---
author: Pai
categories:
- infratructure as code
date: "2020-10-14"
description: Ansible Series
featured: false
series:
- Ansible
tags:
- Ansible
- vagrant
thumbnail: /img/louis-hansel-shotsoflouis-Rf9eElW3Qxo-unsplash.jpg
title: Towards Ansible -> Test Machine Setup and Tool Familiarization
---

In last [post](https://slashpai.github.io/post/towards_ansible_why_what_system_setup/), we learnt what is ansible and why we need tool like ansible. We also setup the development environment. In this post we will setup a test machine using vagrant and get familiarized with ansible config and a few commands.

## Verify VirtualBox and Vagrant Installation

Verify virtualbox and vagrant installation

```bash
slashpai@pai  ~/vagrant/ansible  (⎈ |kind-pai:default) VBoxManage --version
6.1.4r136177
slashpai@pai  ~/vagrant/ansible  (⎈ |kind-pai:default) vagrant --version
Vagrant 2.2.7
```

## Create vagrant test machine

* Create a directory to store vagrant configs and cd to that directory
* Run `vagrant init centos/7`. You can see more options for vagrant boxes [here](https://app.vagrantup.com/boxes/search)

  ```bash
  slashpai@pai  ~/vagrant/ansible  (⎈ |kind-pai:default) vagrant init centos/7
  ==> vagrant: A new version of Vagrant is available: 2.2.10 (installed version: 2.2.7)!
  ==> vagrant: To upgrade visit: https://www.vagrantup.com/downloads.html

  A `Vagrantfile` has been placed in this directory. You are now
  ready to `vagrant up` your first virtual environment! Please read
  the comments in the Vagrantfile as well as documentation on
  `vagrantup.com` for more information on using Vagrant.
  ```

* We need to update network config of Vagrantfile to get a host accessible private ip
* Open Vagrantfile in a editor and uncomment this line `config.vm.network "private_network", ip: "192.168.33.10"`. You can choose a different ip address if wanted. I am using same that is generated by vagrant init command.

* This is how Vagrantfile will look like after removing all other commented lines. I removed that to save some space in this post.

  ```ruby
  # -*- mode: ruby -*-
  # vi: set ft=ruby :

  Vagrant.configure("2") do |config|
    config.vm.box = "centos/7"
    config.vm.network "private_network", ip: "192.168.33.10"
  end
  ```

* Run `vagrant up` to create this machine
* Run `vagrant ssh` from the same directory to ssh to the machine created
* Your test machine is ready now

## Ansible Configuration

* Create a directory `/etc/ansible` in your machine. This is to store default ansible configs and to use as default location for ansible artifacts
* Download [ansible.cfg](https://raw.githubusercontent.com/ansible/ansible/devel/examples/ansible.cfg) and store it in `/etc/ansible`
* Run `bat ansible.cfg` if you have installed bat or simply run `cat ansible.cfg` to see configs
* We will configure some default values in this file. We are doing this step here so that we don't have to pass them explicitely when run ansible commands. ansible uses this as default values for connecting to machine via ssh.

  * Update **remote_user** as `vagrant`
  * Update **private_key_file** as vagrant machine Identity file path. You can get this path if you run `vagrant ssh-config` from same directory where Vagrantfile exists

    ```bash
     slashpai@pai  ~/vagrant/ansible  (⎈ |kind-pai:default) vagrant ssh-config
     Host default
      HostName 127.0.0.1
      User vagrant
      Port 2222
      UserKnownHostsFile /dev/null
      StrictHostKeyChecking no
      PasswordAuthentication no
      IdentityFile /home/slashpai/vagrant/ansible/.vagrant/machines/default/virtualbox/private_key
        IdentitiesOnly yes
        LogLevel FATAL
    ```

* Create a host inventory file where we list down nodes we want to manage
  * Create a file named `hosts` under `/etc/ansible` with following contents. The IP specified here is the ip address of vagrant machine we created earlier.

    ```bash
    [vagrant]
    192.168.33.10
    ```
  
    `[vagrant]` is the node group name, you can give anything you like. So based on node usage we can create different groups. We will see more complex scenarios later. For now this is good enough

## Familiarize with Ansible

Now let's get familiarized with ansible

* List all/specific group hosts in inventory

  ```python
  ansible all/group name--list-hosts
  ```

  ```python
  slashpai@pai  ~  (⎈ |kind-pai:default) ansible all --list-hosts
  hosts (1):
    192.168.33.10
  slashpai@pai  ~  (⎈ |kind-pai:default) ansible vagrant --list-hosts
  hosts (1):
    192.168.33.10
  slashpai@pai  ~  (⎈ |kind-pai:default) ansible unknowngroup --list-hosts
  [WARNING]: Could not match supplied host pattern, ignoring: unknowngroup
  [WARNING]: No hosts matched, nothing to do
    hosts (0):
  ```

* Test connectivity to test machine using ping module

  ```python
  slashpai@pai  ~  (⎈ |kind-pai:default) ansible all -m ping
  192.168.33.10 | SUCCESS => {
      "ansible_facts": {
          "discovered_interpreter_python": "/usr/bin/python"
      },
      "changed": false,
      "ping": "pong"
  }
  slashpai@pai  ~  (⎈ |kind-pai:default) ansible vagrant -m ping
  192.168.33.10 | SUCCESS => {
      "ansible_facts": {
          "discovered_interpreter_python": "/usr/bin/python"
      },
      "changed": false,
      "ping": "pong"
  }
  slashpai@pai  ~  (⎈ |kind-pai:default)
  ```

* Run adhoc commands
    * Adhoc commands are used to run single task on one or more nodes. This is very handy when you need to check something or do a simple task on nodes. The default module for the ansible command-line utility is the [ansible.builtin.command module](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html#command-module)

      ```python
      ansible [pattern] -m [module] -a "[module options]"
      ```

        * pattern here means host group name pattern

    **Example:**

    ```python
    slashpai@pai  ~  (⎈ |kind-pai:default) ansible vagrant -a uptime
    192.168.33.10 | CHANGED | rc=0 >>
    11:18:18 up  1:23,  1 user,  load average: 0.00, 0.01, 0.02
    slashpai@pai  ~  (⎈ |kind-pai:default)
     slashpai@pai  ~  (⎈ |kind-pai:default) ansible vagrant -a "cat /etc/redhat-release"
    192.168.33.10 | CHANGED | rc=0 >>
    CentOS Linux release 7.8.2003 (Core)
    slashpai@pai  ~  (⎈ |kind-pai:default)
    ```

    Now let's try to run a command which needs privileged access. We got error because vagrant user doesn't have access to run the command

    ```python
    slashpai@pai  ~  (⎈ |kind-pai:default) ansible vagrant -a "cat /etc/sudoers.d/vagrant"
    192.168.33.10 | FAILED | rc=1 >>
    cat: /etc/sudoers.d/vagrant: Permission deniednon-zero return code
    ```

    * To fix the error use `--become` flag which runs command in sudo mode

      ```PYTHON
      slashpai@pai  ~  (⎈ |kind-pai:default) ansible vagrant -a "cat /etc/sudoers.d/vagrant" --become
      192.168.33.10 | CHANGED | rc=0 >>
      %vagrant ALL=(ALL) NOPASSWD: ALL
      slashpai@pai  ~  (⎈ |kind-pai:default)
      ```

In next post we will see ansible terminologies, ansible playbook and how to write a playbook using the concepts learnt
